# Caddy reverse proxy configuration for desktop access
# Routes:
#   /desktop      → redirect to /desktop/vnc.html
#   /desktop/*    → noVNC on host (port 6080)
#   /websockify   → noVNC WebSocket (port 6080) - needed for VNC connection
#   /*            → nginx web container (port 80)
#
# Caddy listens on port 8080 to avoid conflict with nginx on port 80

:8080 {
    # Redirect /desktop to /desktop/vnc.html for convenience
    redir /desktop /desktop/vnc.html permanent

    # WebSocket endpoint for VNC - noVNC connects here from the browser
    # Must handle at root level because noVNC uses absolute /websockify path
    # Use handle_path to strip /websockify - websockify expects WebSocket at root /
    handle_path /websockify {
        reverse_proxy localhost:6080 {
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }

    # Desktop/VNC access - proxy to noVNC running on host
    # noVNC serves at /vnc.html and needs WebSocket support
    handle_path /desktop/* {
        reverse_proxy localhost:6080 {
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }

    # Everything else goes to nginx (also on localhost since we use host network)
    handle {
        reverse_proxy localhost:80
    }
}
