services:
  rediacc-nginx:
    image: ${DOCKER_REGISTRY}/rediacc/nginx:${TAG}
    pull_policy: never
    container_name: rediacc-nginx
    hostname: rediacc-nginx
    environment:
      - SYSTEM_DOMAIN=${SYSTEM_DOMAIN:-localhost}
    ports:
      - '${HTTP_PORT:-80}:80'
    networks:
      - internet
      - intranet
    depends_on:
      - rediacc-api
    restart: unless-stopped

  rediacc-api:
    image: ${DOCKER_REGISTRY}/rediacc/api:${TAG}
    pull_policy: never
    container_name: rediacc-api
    hostname: rediacc-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionString=${CONNECTION_STRING}
      - DOCKER_BRIDGE_IMAGE=${DOCKER_BRIDGE_IMAGE}
      - SYSTEM_COMPANY_VAULT_DEFAULTS=${SYSTEM_COMPANY_VAULT_DEFAULTS}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      rediacc-sql:
        condition: service_healthy
    networks:
      - intranet
    restart: unless-stopped

  rediacc-sql:
    image: ${DOCKER_REGISTRY}/rediacc/sql-server:${TAG}
    pull_policy: never
    container_name: rediacc-sql
    hostname: rediacc-sql
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_PID=Express
      - MSSQL_RA_PASSWORD=${MSSQL_RA_PASSWORD}
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - SYSTEM_ADMIN_EMAIL=${SYSTEM_ADMIN_EMAIL}
      - SYSTEM_ADMIN_PASSWORD=${SYSTEM_ADMIN_PASSWORD}
      - SYSTEM_COMPANY_NAME=${SYSTEM_COMPANY_NAME}
      - SYSTEM_COMPANY_VAULT_DEFAULTS=${SYSTEM_COMPANY_VAULT_DEFAULTS}
      - SYSTEM_DEFAULT_BRIDGE_NAME=${SYSTEM_DEFAULT_BRIDGE_NAME}
      - SYSTEM_DEFAULT_REGION_NAME=${SYSTEM_DEFAULT_REGION_NAME}
      - SYSTEM_DEFAULT_TEAM_NAME=${SYSTEM_DEFAULT_TEAM_NAME}
      - TZ=Europe/Berlin
    volumes:
      - ./mssql:/var/opt/mssql
    networks:
      - intranet
    restart: unless-stopped

networks:
  internet:
    name: rediacc_internet
    external: true
  intranet:
    name: rediacc_intranet
    external: true