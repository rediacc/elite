services:
  nginx:
    image: ${DOCKER_REGISTRY}/nginx:${TAG}
    pull_policy: never
    container_name: ${INSTANCE_NAME:-rediacc}-nginx
    hostname: ${INSTANCE_NAME:-rediacc}-nginx
    environment:
      - SYSTEM_DOMAIN=${SYSTEM_DOMAIN:-localhost}
    networks:
      internet:
      intranet:
        aliases:
          - rediacc-nginx
    depends_on:
      - api
    restart: unless-stopped

  api:
    image: ${DOCKER_REGISTRY}/api:${TAG}
    pull_policy: never
    container_name: ${INSTANCE_NAME:-rediacc}-api
    hostname: ${INSTANCE_NAME:-rediacc}-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionString=${CONNECTION_STRING}
      - DOCKER_BRIDGE_IMAGE=${DOCKER_BRIDGE_IMAGE}
      - DOCKER_INTERNET_NETWORK=${INSTANCE_NAME:+${INSTANCE_NAME}_}rediacc_internet
      - SYSTEM_COMPANY_VAULT_DEFAULTS=${SYSTEM_COMPANY_VAULT_DEFAULTS}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      sql:
        condition: service_healthy
    networks:
      internet:
      intranet:
        aliases:
          - rediacc-api
    restart: unless-stopped

  sql:
    image: ${DOCKER_REGISTRY}/sql-server:${TAG}
    pull_policy: never
    container_name: ${INSTANCE_NAME:-rediacc}-sql
    hostname: ${INSTANCE_NAME:-rediacc}-sql
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_PID=Express
      - MSSQL_MEMORY_LIMIT_MB=${MSSQL_MEMORY_LIMIT_MB:-2048}
      - MSSQL_RA_PASSWORD=${MSSQL_RA_PASSWORD}
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - SYSTEM_ADMIN_EMAIL=${SYSTEM_ADMIN_EMAIL}
      - SYSTEM_ADMIN_PASSWORD=${SYSTEM_ADMIN_PASSWORD}
      - SYSTEM_COMPANY_NAME=${SYSTEM_COMPANY_NAME}
      - SYSTEM_COMPANY_VAULT_DEFAULTS=${SYSTEM_COMPANY_VAULT_DEFAULTS}
      - SYSTEM_DEFAULT_BRIDGE_NAME=${SYSTEM_DEFAULT_BRIDGE_NAME}
      - SYSTEM_DEFAULT_REGION_NAME=${SYSTEM_DEFAULT_REGION_NAME}
      - SYSTEM_DEFAULT_TEAM_NAME=${SYSTEM_DEFAULT_TEAM_NAME}
      - TZ=Europe/Berlin
    volumes:
      - ${INSTANCE_DATA_PATH:-./}/mssql:/var/opt/mssql
    networks:
      intranet:
        aliases:
          - rediacc-sql
    restart: unless-stopped

networks:
  internet:
    name: ${INSTANCE_NAME:+${INSTANCE_NAME}_}rediacc_internet
    external: true
  intranet:
    name: ${INSTANCE_NAME:+${INSTANCE_NAME}_}rediacc_intranet
    external: true