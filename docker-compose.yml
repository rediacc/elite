services:
  web:
    image: ${DOCKER_REGISTRY}/web:${TAG}
    pull_policy: never
    container_name: ${INSTANCE_NAME:-rediacc}-web
    hostname: ${INSTANCE_NAME:-rediacc}-web
    environment:
      - SYSTEM_DOMAIN=${SYSTEM_DOMAIN:-localhost}
    networks:
      internet:
      intranet:
        aliases:
          - rediacc-web
    depends_on:
      - api
    restart: unless-stopped

  api:
    image: ${DOCKER_REGISTRY}/api:${TAG}
    pull_policy: never
    container_name: ${INSTANCE_NAME:-rediacc}-api
    hostname: ${INSTANCE_NAME:-rediacc}-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionString=${CONNECTION_STRING}
      - DOCKER_BRIDGE_IMAGE=${DOCKER_BRIDGE_IMAGE}
      - DOCKER_INTERNET_NETWORK=${INSTANCE_NAME:+${INSTANCE_NAME}_}rediacc_internet
      - DOCKER_BRIDGE_NETWORK_MODE=${DOCKER_BRIDGE_NETWORK_MODE}
      - DOCKER_BRIDGE_API_URL=${DOCKER_BRIDGE_API_URL}
      # Database initialization variables (API now handles DB init)
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - MSSQL_RA_PASSWORD=${MSSQL_RA_PASSWORD}
      - REDIACC_DATABASE_NAME=${REDIACC_DATABASE_NAME}
      - REDIACC_SQL_USERNAME=${REDIACC_SQL_USERNAME}
      - SYSTEM_ADMIN_EMAIL=${SYSTEM_ADMIN_EMAIL}
      - SYSTEM_ADMIN_PASSWORD=${SYSTEM_ADMIN_PASSWORD}
      - SYSTEM_COMPANY_NAME=${SYSTEM_COMPANY_NAME}
      - SYSTEM_COMPANY_VAULT_DEFAULTS=${SYSTEM_COMPANY_VAULT_DEFAULTS}
      - SYSTEM_DEFAULT_BRIDGE_NAME=${SYSTEM_DEFAULT_BRIDGE_NAME}
      - SYSTEM_DEFAULT_REGION_NAME=${SYSTEM_DEFAULT_REGION_NAME}
      - SYSTEM_DEFAULT_TEAM_NAME=${SYSTEM_DEFAULT_TEAM_NAME}
      - SSH_PRIVATE_KEY_B64=${SSH_PRIVATE_KEY_B64}
      - SSH_PUBLIC_KEY_B64=${SSH_PUBLIC_KEY_B64}
      - INSTANCE_NAME=${INSTANCE_NAME}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      sql:
        condition: service_healthy
    networks:
      internet:
      intranet:
        aliases:
          - rediacc-api
    restart: unless-stopped

  sql:
    image: ${SQL_BASE_IMAGE:-mcr.microsoft.com/mssql/server:2022-CU18-ubuntu-20.04}
    container_name: ${INSTANCE_NAME:-rediacc}-sql
    hostname: ${INSTANCE_NAME:-rediacc}-sql
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_PID=Express
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD}
    volumes:
      - ${INSTANCE_DATA_PATH:-./}/mssql:/var/opt/mssql
    networks:
      intranet:
        aliases:
          - rediacc-sql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$$MSSQL_SA_PASSWORD\" -Q 'SELECT 1' -C || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

networks:
  internet:
    name: ${INSTANCE_NAME:+${INSTANCE_NAME}_}rediacc_internet
    external: true
  intranet:
    name: ${INSTANCE_NAME:+${INSTANCE_NAME}_}rediacc_intranet
    external: true