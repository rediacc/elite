services:
  web:
    image: ${DOCKER_REGISTRY}/web:${WEB_TAG:-${TAG}}
    pull_policy: never
    container_name: ${INSTANCE_NAME:-rediacc}-web
    hostname: ${INSTANCE_NAME:-rediacc}-web
    environment:
      - SYSTEM_DOMAIN=${SYSTEM_DOMAIN:-localhost}
    networks:
      internet:
      intranet:
        aliases:
          - rediacc-web
    depends_on:
      - api
    restart: unless-stopped

  api:
    image: ${DOCKER_REGISTRY}/api:${API_TAG:-${TAG}}
    pull_policy: never
    container_name: ${INSTANCE_NAME:-rediacc}-api
    hostname: ${INSTANCE_NAME:-rediacc}-api
    environment:
      # Runtime configuration
      - ASPNETCORE_ENVIRONMENT=Production
      - CONNECTION_STRING=${CONNECTION_STRING}
      - DOCKER_BRIDGE_IMAGE=${DOCKER_BRIDGE_IMAGE}
      - DOCKER_INTERNET_NETWORK=${INSTANCE_NAME:+${INSTANCE_NAME}_}rediacc_internet
      - DOCKER_BRIDGE_NETWORK_MODE=${DOCKER_BRIDGE_NETWORK_MODE:-}
      - DOCKER_BRIDGE_API_URL=${DOCKER_BRIDGE_API_URL:-}
      # Schema initialization (used by db-init.sh for DDL)
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - MSSQL_RA_PASSWORD=${MSSQL_RA_PASSWORD}
      - REDIACC_DATABASE_NAME=${REDIACC_DATABASE_NAME}
      - REDIACC_SQL_USERNAME=${REDIACC_SQL_USERNAME}
      - INSTANCE_NAME=${INSTANCE_NAME:-}
      # Organization initialization (used by InitializeOrganization tool)
      - SYSTEM_ADMIN_EMAIL=${SYSTEM_ADMIN_EMAIL}
      - SYSTEM_ADMIN_PASSWORD=${SYSTEM_ADMIN_PASSWORD}
      - SYSTEM_ORGANIZATION_NAME=${SYSTEM_ORGANIZATION_NAME}
      - SYSTEM_ORGANIZATION_VAULT_DEFAULTS=${SYSTEM_ORGANIZATION_VAULT_DEFAULTS}
      - SYSTEM_DEFAULT_BRIDGE_NAME=${SYSTEM_DEFAULT_BRIDGE_NAME}
      - SYSTEM_DEFAULT_REGION_NAME=${SYSTEM_DEFAULT_REGION_NAME}
      - SYSTEM_DEFAULT_TEAM_NAME=${SYSTEM_DEFAULT_TEAM_NAME}
      # CI/TEST mode (bypasses email and captcha validation)
      - CI_MODE=${CI_MODE:-false}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      sql:
        condition: service_healthy
    networks:
      internet:
      intranet:
        aliases:
          - rediacc-api
    restart: unless-stopped

  sql:
    image: ${SQL_BASE_IMAGE:-mcr.microsoft.com/mssql/server:2022-CU21-ubuntu-22.04}
    container_name: ${INSTANCE_NAME:-rediacc}-sql
    hostname: ${INSTANCE_NAME:-rediacc}-sql
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_PID=Express
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD}
    volumes:
      - ${INSTANCE_DATA_PATH:-./}/mssql:/var/opt/mssql
      - ./scripts/mssql.conf:/var/opt/mssql/mssql.conf
    networks:
      intranet:
        aliases:
          - rediacc-sql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$$MSSQL_SA_PASSWORD\" -Q 'SELECT 1' -C || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

networks:
  internet:
    name: ${INSTANCE_NAME:+${INSTANCE_NAME}_}rediacc_internet
    external: true
  intranet:
    name: ${INSTANCE_NAME:+${INSTANCE_NAME}_}rediacc_intranet
    external: true